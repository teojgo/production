#!/usr/bin/env groovy

def methods
stage("Initialization") {
    node{
        def root_dir = pwd()
        methods = load("${root_dir}/jenkins/util.groovy")
        if (methods.checkWorkInProgress(env.ghprbPullTitle)) {
            println "Work in progress detected, aborting execution..."
            return 
        }
    }
}

def pullRequestMessage = env.ghprbPullTitle
def machineConfigurations = [] 
def machinesList
stage("Machine Selection"){
    node{    
        def root_dir = pwd()
        machinesList = load("${root_dir}/jenkins/Machines.groovy")
        def machinesToRun = machinesList.findAll(
            {methods.machineCheck(pullRequestMessage, it.name)})

        for (m in machinesToRun) {
            if( m.name == "dom" || m.name == "daint") {
                machineConfigurations.add(
                    [machine:m, partitions: methods.getMachineConfiguration(
                        pullRequestMessage, m.name)])
            }
            else {
                machineConfigurations.add([machine:m, partitions: [""]])
            }
        }
    }
}

def bashCommand = """chmod +x \$PWD/${params.bashScript}
                     \$PWD/${params.bashScript}
                  """
def builds = [:]
stage("Testing") {
    for (m in machineConfigurations) {
        def machine = m.machine 
        def machineName = machine.name 
        def partitions = m.partitions
        for (p in partitions) {       
            def machineLabel = ""
            if (p != "")  
                machineLabel = "${machineName}-${p}"
            builds[machineLabel] = {
                node(machineName) {
                    println "Hello from machine ${machineLabel}"     
                    def scmVars = checkout scm
                    def commitHash = scmVars.GIT_COMMIT   
                    def project_name = env.JOB_BASE_NAME.trim() 
                    /*------------------------------------------------------
                    ------------------------ SCRIPT ------------------------ 
                    -------------------------------------------------------*/
                    withEnv(["GIT_COMMIT=${commitHash[0..6]}",
                             "system=${machineLabel}",
                             "command=${machine.command}",
                             "unuse_path=${machine.unuse_path}",
                             "project_name=${project_name}"]) {
                        sh bashCommand 
                    }
                }
            }
        }
    }
    parallel builds
}
