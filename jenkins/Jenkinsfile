#!/usr/bin/env groovy

def methods
stage("Initialization") {
    node{
        def root_dir = pwd()
        methods = load("${root_dir}/jenkins/util.groovy")
        switch (params.jenkinsType)
            case "testing" :

                if (methods.checkWorkInProgress(env.ghprbPullTitle)) {
                    println "Work in progress detected, aborting..."
                    return 
                }
                break
            case "production":
            case "regression":
                return
            default:
                println "Project type not recognized, aborting..."
                return
    }
}

def userMessage 
switch (params.jenkinsType)
    case "testing" :
        userMessage = env.ghprbPullTitle
        break
    case "production":
    case "regression":
        userMessage = "${params.customMessage}"
        break;
    default:
        println "Project type not recognized, aborting..."
        return

def machineConfigurations = [] 
def machinesList
stage("Machine Selection"){
    node{    
        def root_dir = pwd()
        machinesList = load("${root_dir}/jenkins/Machines.groovy")
        def machinesToRun = machinesList.findAll(
            {methods.machineCheck(userMessage, it.name)})

        for (m in machinesToRun) {
            if( m.name == "dom" || m.name == "daint") {
                machineConfigurations.add(
                    [machine:m, partitions: methods.getMachineConfiguration(
                        userMessage, m.name)])
            }
            else {
                machineConfigurations.add([machine:m, partitions: [""]])
            }
        }
    }
}

def bashCommand = """chmod +x \$PWD/${params.bashScript}
                     \$PWD/${params.bashScript}
                  """
def builds = [:]
stage("Testing") {
    for (m in machineConfigurations) {
        def machine = m.machine 
        def machineName = machine.name 
        def partitions = m.partitions
        for (p in partitions) {       
            def machineLabel = machineName 
            def arch = p
            println "Partition ${arch}"
            if (p != "")  
                machineLabel = "${machineName}-${p}"
            builds[machineLabel] = {
                node(machineName) {
                    println "Machine name: ${machineName}"
                    println "Hello from machine ${machineLabel}"
                    def scmVars = checkout scm
                    def commitHash = scmVars.GIT_COMMIT   
                    def project_name = env.JOB_BASE_NAME.trim() 
                    /*------------------------------------------------------
                    ------------------------ SCRIPT ------------------------ 
                    -------------------------------------------------------*/
                    withEnv(["GIT_COMMIT=${commitHash[0..6]}",
                             "system=${machineName}",
                             "linkname=${machineLabel}",
                             "command=${machine.command}",
                             "unuse_path=${machine.unuse_path}",
                             "ARCH=${arch}",
                             "project_name=${project_name}"]) {
                        sh bashCommand 
                    }
                }
            }
        }
    }
    parallel builds
}
