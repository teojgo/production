#!/usr/bin/env groovy

def methods
def scmVars
def machinesList
stage("Initialization") {
    node{
        scmVars = checkout scm
        def root_dir = pwd()
        methods = load("${root_dir}/jenkins/util.groovy")
        machinesList = load("${root_dir}/jenkins/Machines.groovy") 
        switch (params.jenkinsType) {
            case "testing" :
                if (methods.checkWorkInProgress(env.ghprbPullTitle)) {
                    println "Work in progress detected, aborting..."
                    return 
                }
                break
            case "production":
            case "regression":
                return
            default:
                println "Project type not recognized, aborting..."
                return
        }
    }
}

def userMessage 
switch (params.jenkinsType) {
    case "testing" :
        userMessage = env.ghprbPullTitle
        break
    case "production":
    case "regression":
        userMessage = "${params.customMessage}"
        break;
    default:
        println "Project type not recognized, aborting..."
        return
}

def machineConfigurations = [] 
stage("Machine Selection"){
    node{    
        def machinesToRun = machinesList.findAll(
            {methods.machineCheck(userMessage, it.name)})
        for (m in machinesToRun) {
            if( m.name == "dom" || m.name == "daint") {
                machineConfigurations.add(
                    [machine:m, partitions: methods.getMachineConfiguration(
                        userMessage, m.name)])
            }
            else {
                machineConfigurations.add([machine:m.name, partitions: [""]])
            }
        }
    }
}

def builds = [:]
stage("Build Stage") {
    for (m in machineConfigurations) {
        def machine = m
        def machineName = machine.name 
        def partitions = machine.partitions
        for (p in partitions) {       
            def machineLabel = machineName 
            def arch = p
            println "Partition ${arch}"
            if (p != "")  
                machineLabel = "${machineName}-${p}"
            builds[machineLabel] = {
                node(machineName) {
                    checkout scm
                    println "Machine name: ${machineName}"
                    println "Hello from machine ${machineLabel}"
                    def commitHash = scmVars.GIT_COMMIT   
                    def project_name = env.JOB_BASE_NAME.trim() 
                    def bashScript
                    def command
                    def unuse_flag = ''
                    def unuse_path = ''
                    switch (params.jenkinsType) {
                        case "testingEB" :
                            bashScript = "testingEB.sh"
                            break
                        case "productionEB":
                            bashScript = "productionEB.sh"
                            break
                        case "regressionEB":
                            bashScript = "regressionEB.sh"
                            unuse_flag = "--unuse=${machine.unuse_path}"
                            break
                        default:
                            println "Jenkins type not recognized, aborting..."
                            return
                    }
                    
                    if (p == "") {
                        command = "\$PWD/jenkins-builds/production.sh --list=\$PWD/jenkins-builds/\${linkname} --prefix=\${PREFIX} $unuse_flag"
                    }
                    else {
                        command = "srun -u --constraint=$p --job-name=$project_name --time=24:00:00 \$PWD/jenkins-builds/production.sh --arch=$p --list=\$PWD/jenkins-builds/\${linkname} --prefix=\${PREFIX} $unuse_flag/ARCH/$p --xalt=no"
                    }
                     
                    def bashCommand = """chmod +x \$PWD/jenkins/${bashScript}
                                         \$PWD/jenkins/${bashScript}
                                      """
                   /*------------------------------------------------------
                    ------------------------ SCRIPT ------------------------ 
                    -------------------------------------------------------*/
                    withEnv(["GIT_COMMIT=${commitHash[0..6]}",
                             "system=${machineName}",
                             "linkname=${machineLabel}",
                             "ARCH=${arch}",
                             "project_name=${project_name}"]) {
                        sh bashCommand 
                    }
                }
            }
        }
    }
    parallel builds
}
